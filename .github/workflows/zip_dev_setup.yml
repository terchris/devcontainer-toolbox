name: ğŸ“¦ Zip and Upload Artifacts

on:
  # Run after CI tests complete successfully
  workflow_run:
    workflows: ["CI Tests"]
    types:
      - completed
    branches:
      - main
  # Allow manual triggering
  workflow_dispatch:

jobs:
  zip-folders:
    # Only run if CI tests passed (or manual trigger)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Set repo URL and version in scripts
        run: |
          REPO="${{ github.repository }}"
          VERSION=$(cat version.txt 2>/dev/null || echo "0.0.0")

          echo "Repository: $REPO"
          echo "Version: $VERSION"

          # Export VERSION to GitHub Actions environment for later steps
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          # Update dev-update.sh (inside .devcontainer/manage/)
          if [ -f ".devcontainer/manage/dev-update.sh" ]; then
            sed -i "s|TOOLBOX_REPO_PLACEHOLDER|$REPO|g" .devcontainer/manage/dev-update.sh
          fi

          # Update install scripts (in repo root)
          sed -i "s|TOOLBOX_REPO_PLACEHOLDER|$REPO|g" install.sh
          sed -i "s|TOOLBOX_REPO_PLACEHOLDER|$REPO|g" install.ps1

          # Write version info to .devcontainer/.version
          echo "VERSION=$VERSION" > .devcontainer/.version
          echo "REPO=$REPO" >> .devcontainer/.version
          echo "UPDATED=$(date +%Y-%m-%d)" >> .devcontainer/.version

          # Update version in devcontainer.json (triggers VS Code rebuild prompt on update)
          sed -i "s|TOOLBOX_VERSION_PLACEHOLDER|$VERSION|g" .devcontainer/devcontainer.json

      - name: ğŸ“¦ Archive dev_containers folders
        run: |
          zip -r dev_containers.zip .devcontainer .devcontainer.extend

      - name: ğŸ’¾ Commit updated install scripts
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add install.sh install.ps1
          git diff --staged --quiet || git commit -m "Update install scripts with repo URL [skip ci]"
          git push || echo "Nothing to push or push failed"

      - name: ğŸ—‘ï¸ Delete existing release
        uses: dev-drprasad/delete-tag-and-release@v0.2.1
        with:
          delete_release: true
          tag_name: latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: â¬†ï¸ Upload dev_containers.zip as an artifact
        uses: actions/upload-artifact@v4
        with:
          name: dev_containers
          path: dev_containers.zip

      - name: ğŸ”– Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: latest
          name: DevContainers v${{ env.VERSION }}
          draft: false
          prerelease: false
          files: dev_containers.zip
